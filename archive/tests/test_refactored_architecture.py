#!/usr/bin/env python3
"""
Test Suite f√ºr die refactored LLM Training Architecture

Dieses Script testet alle Komponenten der neuen modularen Architektur
und validiert, dass das Refactoring erfolgreich war.
"""

import sys
import os
import traceback
from typing import Dict, List

# Add current directory to path
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

def test_imports():
    """Testet alle Imports der neuen Architektur."""
    print("üß™ Testing Imports...")
    
    tests = []
    
    try:
        # Core interfaces
        from core.interfaces import TrainingInterface, ModelInterface
        tests.append(("‚úÖ", "Core Interfaces", "TrainingInterface, ModelInterface"))
        
        # Models
        from core.models import MemoryOptimizedLLM, GPUOptimizedAttention
        tests.append(("‚úÖ", "Model Components", "MemoryOptimizedLLM, GPUOptimizedAttention"))
        
        # Training
        from core.training import Trainer, AdvancedMetrics
        tests.append(("‚úÖ", "Training Components", "Trainer, AdvancedMetrics"))
        
        # Data
        from core.data import DatasetFactory, CacheManager
        tests.append(("‚úÖ", "Data Components", "DatasetFactory, CacheManager"))
        
        # Checkpoints
        from core.checkpoints import CheckpointManager, ModelSaver
        tests.append(("‚úÖ", "Checkpoint Components", "CheckpointManager, ModelSaver"))
        
        # Monitoring
        from core.monitoring import ProgressDisplay, MemoryMonitor
        tests.append(("‚úÖ", "Monitoring Components", "ProgressDisplay, MemoryMonitor"))
        
        # Utils
        from core.utils import GPUUtils, SystemUtils
        tests.append(("‚úÖ", "Utility Components", "GPUUtils, SystemUtils"))
        
        # Compatibility
        from core.utils.compatibility import LegacyFunctionAdapter
        tests.append(("‚úÖ", "Compatibility Layer", "LegacyFunctionAdapter"))
        
    except Exception as e:
        tests.append(("‚ùå", "Import Error", str(e)))
    
    # Print results
    for status, component, details in tests:
        print(f"   {status} {component}: {details}")
    
    return all(test[0] == "‚úÖ" for test in tests)


def test_model_creation():
    """Testet Model-Erstellung mit der neuen API."""
    print("\nüß† Testing Model Creation...")
    
    try:
        from core.interfaces import ModelInterface
        
        # Erstelle Model Interface
        model_interface = ModelInterface()
        
        # Erstelle Model
        model = model_interface.create_model()
        
        # Validiere Model
        is_valid = model_interface.validate_model()
        
        if is_valid:
            print("   ‚úÖ Model Creation: Erfolgreich")
            print("   ‚úÖ Model Validation: Bestanden")
            
            # Model Info
            info = model_interface.get_model_info()
            print(f"   üìä Model Info: {info.get('parameter_size', 'Unknown')} Parameter")
            
            # Cleanup
            model_interface.cleanup()
            return True
        else:
            print("   ‚ùå Model Validation: Fehlgeschlagen")
            return False
            
    except Exception as e:
        print(f"   ‚ùå Model Creation Error: {e}")
        return False


def test_training_interface():
    """Testet Training Interface (ohne vollst√§ndiges Training)."""
    print("\nüèÉ Testing Training Interface...")
    
    try:
        from core.interfaces import TrainingInterface
        
        # Erstelle Training Interface
        training_interface = TrainingInterface()
        
        # Teste Initialisierung
        training_interface.initialize_training_environment()
        print("   ‚úÖ Environment Initialization: Erfolgreich")
        
        # Teste Model Creation
        model = training_interface.create_model()
        if model is not None:
            print("   ‚úÖ Model Creation via Interface: Erfolgreich")
        else:
            print("   ‚ùå Model Creation via Interface: Fehlgeschlagen")
            return False
        
        # Teste Dataset Creation (synthetic)
        dataloader = training_interface.create_dataset(use_real_data=False, dataset_size="small")
        if dataloader is not None:
            print("   ‚úÖ Dataset Creation: Erfolgreich")
        else:
            print("   ‚ùå Dataset Creation: Fehlgeschlagen")
            return False
        
        # Teste Trainer Creation
        trainer = training_interface.create_trainer()
        if trainer is not None:
            print("   ‚úÖ Trainer Creation: Erfolgreich")
        else:
            print("   ‚ùå Trainer Creation: Fehlgeschlagen")
            return False
        
        # Cleanup
        training_interface.cleanup()
        print("   ‚úÖ Cleanup: Erfolgreich")
        
        return True
        
    except Exception as e:
        print(f"   ‚ùå Training Interface Error: {e}")
        traceback.print_exc()
        return False


def test_backward_compatibility():
    """Testet Backward Compatibility mit der alten API."""
    print("\nüîÑ Testing Backward Compatibility...")
    
    try:
        # Teste Legacy Imports
        import importlib.util
        spec = importlib.util.spec_from_file_location("training_windows", "training-windows.py")
        training_windows = importlib.util.module_from_spec(spec)
        spec.loader.exec_module(training_windows)
        memory_optimized_training_loop = training_windows.memory_optimized_training_loop
        check_gpu_setup = training_windows.check_gpu_setup
        print("   ‚úÖ Legacy Imports: Erfolgreich")
        
        # Teste Legacy Functions (ohne Ausf√ºhrung)
        if callable(memory_optimized_training_loop):
            print("   ‚úÖ memory_optimized_training_loop: Verf√ºgbar")
        else:
            print("   ‚ùå memory_optimized_training_loop: Nicht verf√ºgbar")
            return False
        
        if callable(check_gpu_setup):
            print("   ‚úÖ check_gpu_setup: Verf√ºgbar")
        else:
            print("   ‚ùå check_gpu_setup: Nicht verf√ºgbar")
            return False
        
        return True
        
    except Exception as e:
        print(f"   ‚ùå Backward Compatibility Error: {e}")
        return False


def test_system_components():
    """Testet System-Komponenten."""
    print("\nüîß Testing System Components...")
    
    try:
        from core.utils import GPUUtils, SystemUtils
        
        # GPU Utils
        gpu_utils = GPUUtils()
        gpu_info = gpu_utils.gpu_info
        print(f"   üìä GPU Info: {gpu_info['count']} GPU(s) verf√ºgbar")
        
        # System Utils
        system_utils = SystemUtils()
        system_info = system_utils.get_system_info()
        if 'platform' in system_info:
            platform_info = system_info['platform']
            print(f"   üìä System: {platform_info['system']} {platform_info['machine']}")
        
        print("   ‚úÖ System Components: Erfolgreich")
        return True
        
    except Exception as e:
        print(f"   ‚ùå System Components Error: {e}")
        return False


def run_comprehensive_test():
    """F√ºhrt alle Tests aus und gibt Gesamtergebnis zur√ºck."""
    print("üöÄ COMPREHENSIVE ARCHITECTURE TEST")
    print("=" * 50)
    print("Testing refactored LLM Training Framework...")
    print("=" * 50)
    
    tests = [
        ("Import Tests", test_imports),
        ("Model Creation", test_model_creation),
        ("Training Interface", test_training_interface),
        ("Backward Compatibility", test_backward_compatibility),
        ("System Components", test_system_components)
    ]
    
    results = []
    
    for test_name, test_func in tests:
        try:
            result = test_func()
            results.append((test_name, result))
        except Exception as e:
            print(f"\n‚ùå {test_name} crashed: {e}")
            results.append((test_name, False))
    
    # Zusammenfassung
    print("\n" + "=" * 50)
    print("üìä TEST RESULTS SUMMARY")
    print("=" * 50)
    
    passed = 0
    total = len(results)
    
    for test_name, result in results:
        status = "‚úÖ PASSED" if result else "‚ùå FAILED"
        print(f"{status}: {test_name}")
        if result:
            passed += 1
    
    print("=" * 50)
    print(f"üìà OVERALL RESULT: {passed}/{total} tests passed")
    
    if passed == total:
        print("üéâ ALL TESTS PASSED! Refactoring was successful!")
        print("\n‚úÖ Die neue modulare Architektur funktioniert korrekt")
        print("‚úÖ Backward Compatibility ist gew√§hrleistet")
        print("‚úÖ Alle Komponenten sind funktionsf√§hig")
        return True
    else:
        print("‚ö†Ô∏è Some tests failed. Check the errors above.")
        return False


def quick_smoke_test():
    """Schneller Smoke Test f√ºr die wichtigsten Funktionen."""
    print("üí® QUICK SMOKE TEST")
    print("=" * 30)
    
    try:
        # Test 1: Import der Hauptkomponenten
        from core.interfaces import TrainingInterface, ModelInterface
        print("‚úÖ Core imports working")
        
        # Test 2: Model Interface
        model_interface = ModelInterface()
        model = model_interface.create_model()
        model_interface.cleanup()
        print("‚úÖ Model creation working")
        
        # Test 3: Legacy compatibility
        import importlib.util
        spec = importlib.util.spec_from_file_location("training_windows", "training-windows.py")
        training_windows = importlib.util.module_from_spec(spec)
        spec.loader.exec_module(training_windows)
        memory_optimized_training_loop = training_windows.memory_optimized_training_loop
        print("‚úÖ Legacy compatibility working")
        
        print("\nüéâ SMOKE TEST PASSED!")
        print("Die refactored Architektur ist grunds√§tzlich funktionsf√§hig.")
        return True
        
    except Exception as e:
        print(f"\n‚ùå SMOKE TEST FAILED: {e}")
        return False


if __name__ == "__main__":
    if len(sys.argv) > 1 and sys.argv[1] == "--quick":
        quick_smoke_test()
    else:
        run_comprehensive_test()
